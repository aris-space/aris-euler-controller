//
// Created by Tun Kapgen on 05.06.20.
//

#include "../Inc/controller.h"

void control_init(control_data_t *control_data){
    control_data_reset(control_data);

    control_data->sf_velocity = 0;
    control_data->sf_ref_altitude_AGL = 0;
    control_data->tracking_feedback = 0;

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;

    const double optimal_trajectory_coeff[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000129640793126990997898884, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002239007863367679963922518768, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011511810170218099173953652096091, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000002908878534127669870262358555686020, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000134195789529913009002389763890053831533, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000191645431953910014940093118313736995885935, -0.000000000000000000000000000000000000000000000000000000000000000000000000001405056223114930024654195426355870330503313362, -0.000000000000000000000000000000000000000000000000000000000000000000000005711517274853489882635061404043999228344229283595, 0.000000000000000000000000000000000000000000000000000000000000000000005223832949602040079225121610710986803769612426796822, 0.000000000000000000000000000000000000000000000000000000000000000094122899914694893545456752655362153522531455896772993803, 0.000000000000000000000000000000000000000000000000000000000000176287226567442013152052178227770560389488152544767254611370, -0.000000000000000000000000000000000000000000000000000000000903543625084554036499956568799393749128366387105004271444122074, -0.000000000000000000000000000000000000000000000000000004877304726330350058199435749456130575648213617547089217604325285819, 0.000000000000000000000000000000000000000000000000002075607029913619931984281593830320741704113483473012513084235251165883, 0.000000000000000000000000000000000000000000000077956342030180896008060413563266087690898930045065245822263808595562687385, 0.000000000000000000000000000000000000000000101286652977997002251883620886768014260569681650602646929801773119500114044864, -0.000000000000000000000000000000000000001082359494876210029719447887398929095190220861172359548524836994077962308978120128, -0.000000000000000000000000000000000002257633338213720127487208167492723527253461274460597963135182952941900567018827420317, 0.000000000000000000000000000000017622981564998799910815396774669589615505728640562668707736705217363430572422697728725283, 0.000000000000000000000000000015344582499469999748148201978628877849828076182984129177430747553561381736814996090689788844, -0.000000000000000000000000329376895864402021708940556428992166118391698152299659384951359300357232040568078446085564792156, 0.000000000000000000001174695106166099943860876444372207986476281530004192561267642447297987473575631156563758850097656250, -0.000000000000000002320253796159110162458924161824184768614628912597203785894706129511178005486726760864257812500000000000, 0.000000000000002958376849811309932063190367415466362941513017367767268694933591177687048912048339843750000000000000000000, -0.000000000002544921973588600011006238704376568033997674245227926803636364638805389404296875000000000000000000000000000000, 0.000000001484954008006769970045755723366334710711100797198014333844184875488281250000000000000000000000000000000000000000, -0.000000577175388535486959670696861107730413209537800867110490798950195312500000000000000000000000000000000000000000000000, 0.000143811747147539999505672092539043660508468747138977050781250000000000000000000000000000000000000000000000000000000000, -0.021956612810577199462747088887226709630340337753295898437500000000000000000000000000000000000000000000000000000000000000, 2.386344286786960200430485201650299131870269775390625000000000000000000000000000000000000000000000000000000000000000000000, 13.130852698464400063471657631453126668930053710937500000000000000000000000000000000000000000000000000000000000000000000000};
    memcpy(control_data->optimal_trajectory_coeff, optimal_trajectory_coeff, sizeof(optimal_trajectory_coeff));

    #if CONTROLLER_TYPE == 1
        init_gains(control_data);
    #elif CONTROLLER_TYPE == 2
        init_params(control_data);
    #endif
}

void control_step(control_data_t *control_data, state_est_data_t *state_est_data, 
                  flight_phase_detection_t *flight_phase_detection, env_t *env) {
    /* Update the control data struct*/
    control_data->sf_velocity = ((float)state_est_data->velocity_rocket[0]) / 1000;
    control_data->sf_ref_altitude_AGL = ((float) state_est_data->position_world[2]) / 1000;
    control_data->tracking_feedback = ((float) state_est_data->airbrake_extension) / 1000000;

    #if CONTROLLER_TYPE == 2
        compute_control_input(control_data, flight_phase_detection, env);
    #else
        compute_control_input(control_data, flight_phase_detection);
    #endif
}
