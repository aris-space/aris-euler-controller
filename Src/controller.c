//
// Created by Tun Kapgen on 05.06.20.
//

#include "../Inc/controller.h"

void control_init(control_data_t *control_data){
    control_data_reset(control_data);

    control_data->sf_velocity = 0;
    control_data->sf_ref_altitude_AGL = 0;
    control_data->tracking_feedback = 0;

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;

    const double optimal_trajectory_coeff[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027411389134354999755, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400333617478819978558437, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001103844605225330066444625961, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005913969172819209921976381380022, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000006443616328137509647356263397232881, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000121532087486964998852972942516821312321, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000318930149202620025275368127982054854287990, -0.000000000000000000000000000000000000000000000000000000000000000000000000001003440910028299975003969397866120240240893972, -0.000000000000000000000000000000000000000000000000000000000000000000000010395116149777200955411653549248120984104817838462, -0.000000000000000000000000000000000000000000000000000000000000000000026037212126643199626279846569038331263586685839195816, 0.000000000000000000000000000000000000000000000000000000000000000091645767868291007522546974467169281325771042831043550757, 0.000000000000000000000000000000000000000000000000000000000000937553147795057933170925875478098891225926845805373795268481, 0.000000000000000000000000000000000000000000000000000000002210047604875960037665972810764755834559108157498844078270251949, -0.000000000000000000000000000000000000000000000000000010306478821986800247349167683414937896922922216013769694969581476529, -0.000000000000000000000000000000000000000000000000088349331819269806524939488444393323043496273847164481148771495120700006, -0.000000000000000000000000000000000000000000000104914551354329000618508600024352144702760934779215322916384090486428505115, 0.000000000000000000000000000000000000000001591641886608000101106116863762914173822178975751819380790040258434410473787625, 0.000000000000000000000000000000000000006773608443543689476481931423616625023365320626932283906792633284733766294917691911, -0.000000000000000000000000000000000021867612109305100774159930884263556626774643409835209843404827846621039872416575348847, -0.000000000000000000000000000000183784243708874992821425118555943555525784434460375801157035942754066875015501325444158831, 0.000000000000000000000000000505228674315566966895432782754013568184236697697905880844519272107029351191742616578039815067, 0.000000000000000000000003717249061099920062739800344471156863840497019793586838346265187674188901212346536340191960334778, -0.000000000000000000026063649844827199513645725809438176151255231251605591418721991070484023111930582672357559204101562500, 0.000000000000000075878275917591297634163885467706885575457626371201347303951934009091928601264953613281250000000000000000, -0.000000000000129790572516121997113976848478129044186461099608109748260176274925470352172851562500000000000000000000000000, 0.000000000140794200748009999768922915352889826956506169608474010601639747619628906250000000000000000000000000000000000000, -0.000000097634982930669802345309028768216563776149996556341648101806640625000000000000000000000000000000000000000000000000, 0.000042034070734335202655651553271809461875818669795989990234375000000000000000000000000000000000000000000000000000000000, -0.010837816999641099180440306781747494824230670928955078125000000000000000000000000000000000000000000000000000000000000000, 1.950410888256399966067533569002989679574966430664062500000000000000000000000000000000000000000000000000000000000000000000, 17.263277103281399860179590177722275257110595703125000000000000000000000000000000000000000000000000000000000000000000000000};
    memcpy(control_data->optimal_trajectory_coeff, optimal_trajectory_coeff, sizeof(optimal_trajectory_coeff));

    #if CONTROLLER_TYPE == 1
        init_gains(control_data);
    #elif CONTROLLER_TYPE == 2
        init_params(control_data);
    #endif
}

void control_step(control_data_t *control_data, state_est_data_t *state_est_data, 
                  flight_phase_detection_t *flight_phase_detection, env_t *env) {
    /* Update the control data struct*/
    control_data->sf_velocity = ((float)state_est_data->velocity_world[2]) / 1000;
    control_data->sf_ref_altitude_AGL = ((float) state_est_data->position_world[2]) / 1000;
    control_data->tracking_feedback = ((float) state_est_data->airbrake_extension) / 1000000;

    #if CONTROLLER_TYPE == 2
        compute_control_input(control_data, flight_phase_detection, env);
    #else
        compute_control_input(control_data, flight_phase_detection);
    #endif
}
