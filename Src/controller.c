//
// Created by Tun Kapgen on 05.06.20.
//

#include "../Inc/controller.h"

void control_init(control_data_t *control_data){
    control_data_reset(control_data);

    control_data->sf_velocity = 0;
    control_data->sf_ref_altitude_AGL = 0;
    control_data->tracking_feedback = 0;

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;

    const double optimal_trajectory_coeff[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022269308615441700609172, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000408966724473023025009666506, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002252564991067019926799764086292, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000398299840576687013506607463961213, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000029279380233847901626599507427234293281, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000040183286130737200218277575818559437441122, -0.000000000000000000000000000000000000000000000000000000000000000000000000000350622485429397999051836843694515817158229566, -0.000000000000000000000000000000000000000000000000000000000000000000000001418180504371989966990353608818752369493531462086, 0.000000000000000000000000000000000000000000000000000000000000000000001720709569937169883634424193719619113368744071780927, 0.000000000000000000000000000000000000000000000000000000000000000027024518359912600469319188662123581570644056808592192762, 0.000000000000000000000000000000000000000000000000000000000000048129376067677201881283761384141652248945924605285642880353, -0.000000000000000000000000000000000000000000000000000000000305840034226918010996874635370530962391236881123241344156810502, -0.000000000000000000000000000000000000000000000000000001605371085770380144045230312818756700745210661255342463230585476004, 0.000000000000000000000000000000000000000000000000001151892117275160009053556360808568533517388687197776537014017494379040, 0.000000000000000000000000000000000000000000000029675884859591801468832969081950333305727757948816112318793322164140192679, 0.000000000000000000000000000000000000000000033873742908352798939974641750082778900699100115525840515400518203101167177599, -0.000000000000000000000000000000000000000471019930024507993365546936573796416291233118322043187877546121713057080740760383, -0.000000000000000000000000000000000000911691546197690034313526275379743636561304032894590449182535970422394038365005338386, 0.000000000000000000000000000000008566557089965920619746668541395046108497387596386942229218217481028497256557219837868472, 0.000000000000000000000000000005985176575489880320405047642756162613627856618289488388777991520789576626425257735442109208, -0.000000000000000000000000174484487285903005419698309675746500436631214776902292651520800105102021460012906572956126183271, 0.000000000000000000000678547588354283967198662599533829094309102169005149801238492568433713358899694867432117462158203125, -0.000000000000000001446078554872099964171375882387922560917449041334578371809094221589475637301802635192871093750000000000, 0.000000000000001982692573183100107135564518212020726882228440976496663950001675402745604515075683593750000000000000000000, -0.000000000001831013186906930193713993556361227662502427770974122722691390663385391235351562500000000000000000000000000000, 0.000000001145642252342000066039214826887990966719499397186154965311288833618164062500000000000000000000000000000000000000, -0.000000476978986074657008741365087772789976838794245850294828414916992187500000000000000000000000000000000000000000000000, 0.000127131156959041006051028266377045383705990388989448547363281250000000000000000000000000000000000000000000000000000000, -0.020729586065230700547834530311774869915097951889038085937500000000000000000000000000000000000000000000000000000000000000, 2.401483705782419875163213873747736215591430664062500000000000000000000000000000000000000000000000000000000000000000000000, 14.050945514166899741326233197469264268875122070312500000000000000000000000000000000000000000000000000000000000000000000000};
    memcpy(control_data->optimal_trajectory_coeff, optimal_trajectory_coeff, sizeof(optimal_trajectory_coeff));

    #if CONTROLLER_TYPE == 1
        init_gains(control_data);
    #elif CONTROLLER_TYPE == 2
        init_params(control_data);
    #endif
}

void control_step(control_data_t *control_data, state_est_data_t *state_est_data, 
                  flight_phase_detection_t *flight_phase_detection, env_t *env) {
    /* Update the control data struct*/
    control_data->sf_velocity = ((float)state_est_data->velocity_rocket[0]) / 1000;
    control_data->sf_ref_altitude_AGL = ((float) state_est_data->position_world[2]) / 1000;
    control_data->tracking_feedback = ((float) state_est_data->airbrake_extension) / 1000000;

    #if CONTROLLER_TYPE == 2
        compute_control_input(control_data, flight_phase_detection, env);
    #else
        compute_control_input(control_data, flight_phase_detection);
    #endif
}
