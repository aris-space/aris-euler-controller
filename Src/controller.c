//
// Created by Tun Kapgen on 05.06.20.
//

#include "../Inc/controller.h"

void control_init(control_data_t *control_data){
    control_data_reset(control_data);

    control_data->sf_velocity = 0;
    control_data->sf_ref_altitude_AGL = 0;
    control_data->tracking_feedback = 0;

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;

    const double optimal_trajectory_coeff[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022180099423655100118879, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000261733296359332022719145256, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000585437020784300968012205043491, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000002502778946338870059169639971960189, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000002247463562316390039568945346045351531, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000033435516649793301581120659996991801151791, 0.000000000000000000000000000000000000000000000000000000000000000000000000000070285093289854203327268125658916507178850655, -0.000000000000000000000000000000000000000000000000000000000000000000000000178848470937342005451686053310692943914577825783, -0.000000000000000000000000000000000000000000000000000000000000000000001486364795318669907288205281691304077536071190974355, -0.000000000000000000000000000000000000000000000000000000000000000003007163616656090052174167356557205696490266887547859076, 0.000000000000000000000000000000000000000000000000000000000000008354563135986630201840773533327791099007804536513673092678, 0.000000000000000000000000000000000000000000000000000000000069435748593566295719798930244189996287554389188607881258521297, 0.000000000000000000000000000000000000000000000000000000133953186178112001538353665046743415922939455635833798352435433965, -0.000000000000000000000000000000000000000000000000000479450745958629000357430303288459729004928124359342689906825384446285, -0.000000000000000000000000000000000000000000000003381354270142979967307115104777633271659344668464670688864064592330903120, -0.000000000000000000000000000000000000000000003462927374959050060910470388507233588634222771719053406015474660081033731755, 0.000000000000000000000000000000000000000038293208122051197730610365423265426495900050764049831927643883214858909695999051, 0.000000000000000000000000000000000000135332804420646006240105188100215761653154339441355347807018748388824416625419767643, -0.000000000000000000000000000000000325439755159167996756981130450883764451196065166572014201513695406407836026954621661786, -0.000000000000000000000000000002319346853566810091659314410222786714251198651872858834214485087668708423556810423876717309, 0.000000000000000000000000004782419351738939751794345869943760172474902998503012822776293846657215402817797667012200690806, 0.000000000000000000000030088297605688099144076331083041763466747462884678063164685217489857649297846364788711071014404297, -0.000000000000000000163623904327575989931502818111164171488171344132208848143328339119761949405074119567871093750000000000, 0.000000000000000375749154364763983771583093233370597513665127510293362256277305277762934565544128417968750000000000000000, -0.000000000000510582115826392973970920644869634188230816951303836503939237445592880249023437500000000000000000000000000000, 0.000000000443310559928976003127550626465268324150059697785764001309871673583984375000000000000000000000000000000000000000, -0.000000248029460547484011805096423136651750951386929955333471298217773437500000000000000000000000000000000000000000000000, 0.000086711638216624599287754571186326302267843857407569885253906250000000000000000000000000000000000000000000000000000000, -0.018251634408001201487214970597960927989333868026733398437500000000000000000000000000000000000000000000000000000000000000, 2.670557033187610063151851136353798210620880126953125000000000000000000000000000000000000000000000000000000000000000000000, 19.191485525083798791001754580065608024597167968750000000000000000000000000000000000000000000000000000000000000000000000000};
    memcpy(control_data->optimal_trajectory_coeff, optimal_trajectory_coeff, sizeof(optimal_trajectory_coeff));

    #if CONTROLLER_TYPE == 1
        init_gains(control_data);
    #elif CONTROLLER_TYPE == 2
        init_params(control_data);
    #endif
}

void control_step(control_data_t *control_data, state_est_data_t *state_est_data, 
                  flight_phase_detection_t *flight_phase_detection, env_t *env) {
    /* Update the control data struct*/
    control_data->sf_velocity = ((float)state_est_data->velocity_rocket[0]) / 1000;
    control_data->sf_ref_altitude_AGL = ((float) state_est_data->position_world[2]) / 1000;
    control_data->tracking_feedback = ((float) state_est_data->airbrake_extension) / 1000000;

    #if CONTROLLER_TYPE == 2
        compute_control_input(control_data, flight_phase_detection, env);
    #else
        compute_control_input(control_data, flight_phase_detection);
    #endif
}
